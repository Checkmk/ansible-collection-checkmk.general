---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer attribute."
  ansible.builtin.set_fact:
    checkmk_var_customer: "{{ 'provider' if outer_item.edition == 'cme' else None }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create rules."
  rule:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    ruleset: "{{ item.ruleset }}"
    rule: "{{ item.rule }}"
    state: "present"
  loop: "{{ checkmk_var_rules }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get all rulesets."
  ansible.builtin.debug:
    var: __checkmk_var_rulesets
  vars:
    __checkmk_var_rulesets: "{{ lookup('checkmk.general.rulesets',
                  regex='',
                  rulesets_used=True,
                  rulesets_deprecated=False,
                  server_url=checkmk_var_server_url,
                  site=outer_item.site,
                  validate_certs=False,
                  api_user=checkmk_var_api_user,
                  api_secret=checkmk_var_api_secret)
              }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get list of all rulesets."
  ansible.builtin.debug:
    msg: "Ruleset {{ item.id }} contains {{ item.extensions.number_of_rules | default('0') }}"
  loop: "{{ lookup('checkmk.general.rulesets',
             regex='',
             rulesets_used=True,
             rulesets_deprecated=False,
             server_url=checkmk_var_server_url,
             site=outer_item.site,
             validate_certs=False,
             api_user=checkmk_var_api_user,
             api_secret=checkmk_var_api_secret)
         }}"
  loop_control:
    label: "{{ item.id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get particular rulesets."
  ansible.builtin.debug:
    var: __checkmk_var_rulesets
  vars:
    __checkmk_var_rulesets: "{{ lookup('checkmk.general.rulesets',
                  regex='file',
                  rulesets_used=False,
                  rulesets_deprecated=False,
                  server_url=checkmk_var_server_url,
                  site=outer_item.site,
                  validate_certs=False,
                  api_user=checkmk_var_api_user,
                  api_secret=checkmk_var_api_secret)
              }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify number of rules using lookup-ruleset."
  ansible.builtin.assert:
    # For each rule that we created, check, if the number of rules in its ruleset is 1.
    that: "__checkmk_var_ruleset.number_of_rules == 1"
  vars:
    __checkmk_var_ruleset: "{{ lookup('checkmk.general.ruleset',
                      ruleset=item,
                      server_url=checkmk_var_server_url,
                      site=outer_item.site,
                      validate_certs=False,
                      api_user=checkmk_var_api_user,
                      api_secret=checkmk_var_api_secret)
                  }}"
  loop: "{{ checkmk_var_ruleset_regexes }}"

# We need this hack to overwrite the colliding global variable
- name: "Set fact: checkmk_var_server_url."
  ansible.builtin.set_fact:
    checkmk_var_server_url: "http://127.0.0.1:5104/"
  when: outer_item.site == "stable_cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Use variables from inventory: ruleset."
  ansible.builtin.assert:
    # For each rule that we created, check, if the number of rules in its ruleset is 1.
    that: "__checkmk_var_ruleset.number_of_rules == 1"
  vars:
    __checkmk_var_ruleset: "{{ lookup('checkmk.general.ruleset', ruleset=item) }}"
  loop: "{{ checkmk_var_ruleset_regexes }}"
  when: outer_item.site == "stable_cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Use variables from inventory: rulesets."
  ansible.builtin.debug:
    var: __checkmk_var_rulesets
  vars:
    __checkmk_var_rulesets: "{{ lookup('checkmk.general.rulesets', regex='file', rulesets_used=False, rulesets_deprecated=False) }}"
  when: outer_item.site == "stable_cme"

# We need this hack to overwrite the colliding global variable
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Use variables from inventory."
  when: outer_item.site == "stable_cme"
  block:
    - name: "Set checkmk_var_server_url for isolated testing."
      ansible.builtin.set_fact:
        checkmk_var_server_url: "http://127.0.0.1:5104/"

    - name: "Test plugin with variables from inventory for: ruleset."
      ansible.builtin.assert:
        # For each rule that we created, check, if the number of rules in its ruleset is 1.
        that: "__checkmk_var_ruleset.number_of_rules == 1"
      vars:
        __checkmk_var_ruleset: "{{ lookup('checkmk.general.ruleset', ruleset=item) }}"
      loop: "{{ checkmk_var_ruleset_regexes }}"

    - name: "Test plugin with variables from inventory for: rulesets."
      ansible.builtin.debug:
        var: __checkmk_var_rulesets
      vars:
        __checkmk_var_rulesets: "{{ lookup('checkmk.general.rulesets', regex='file', rulesets_used=False, rulesets_deprecated=False) }}"
