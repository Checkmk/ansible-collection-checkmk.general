---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: "provider"
  when: outer_item.edition == "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: null
  when: outer_item.edition != "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create notification rule."
  notification:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_config: "{{ checkmk_var_notification_config }}"
    state: "present"
  register: __checkmk_var_notification_create
  failed_when: __checkmk_var_notification_create.failed

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify notification rule created."
  ansible.builtin.assert:
    that:
      - __checkmk_var_notification_create.changed is true
      - "'200 - OK: The operation was done successfully' in __checkmk_var_notification_create.msg"
    fail_msg: "Notification rule was not created successfully!"
    success_msg: "Notification rule created successfully."

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update notification rule."
  notification:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_id: "{{ __checkmk_var_notification_create.content.id }}"
    rule_config: "{{ checkmk_var_notification_config_updated }}"
    state: "present"
  register: __checkmk_var_notification_update
  failed_when: __checkmk_var_notification_update.failed

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify notification rule updated."
  ansible.builtin.assert:
    that:
      - __checkmk_var_notification_update.changed is true
      - "'200 - OK: The operation was done successfully' in __checkmk_var_notification_update.msg"
    fail_msg: "Notification rule was not updated successfully!"
    success_msg: "Notification rule updated successfully."

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete notification rule."
  notification:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_id: "{{ __checkmk_var_notification_create.content.id }}"
    state: "absent"
  register: __checkmk_var_notification_delete
  failed_when: __checkmk_var_notification_delete.failed

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify notification rule deleted."
  ansible.builtin.assert:
    that:
      - __checkmk_var_notification_delete.changed is true
      - "'204 - Operation done successfully. No further output.' in __checkmk_var_notification_delete.msg or '200 - OK: The operation was done successfully' in __checkmk_var_notification_delete.msg"
    fail_msg: "Notification rule was not deleted successfully!"
    success_msg: "Notification rule deleted successfully."

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete notification rule again (idempotency)."
  notification:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_id: "{{ __checkmk_var_notification_create.content.id }}"
    state: "absent"
  register: __checkmk_var_notification_delete_again
  failed_when: __checkmk_var_notification_delete_again.changed
