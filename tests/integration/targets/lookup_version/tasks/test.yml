---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer attribute."
  ansible.builtin.set_fact:
    checkmk_var_customer: "{{ 'provider' if outer_item.edition == 'cme' else None }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get Checkmk version information."
  ansible.builtin.set_fact:
    __checkmk_var_version: "{{ lookup('checkmk.general.version',
                        server_url=checkmk_var_server_url,
                        site=outer_item.site,
                        validate_certs=False,
                        automation_user=checkmk_var_automation_user,
                        automation_secret=checkmk_var_automation_secret) }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Extract Checkmk version information."
  ansible.builtin.set_fact:
    __checkmk_var_version_number: "{{ (__checkmk_var_version.split('.')[:-1]) | join('.') }}"
    __checkmk_var_version_edition: "{{ __checkmk_var_version.split('.')[-1] }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify Checkmk version."
  ansible.builtin.assert:
    that: "outer_item.version == __checkmk_var_version_number"
    fail_msg: "Expected {{ outer_item.version }}, but found {{ __checkmk_var_version_number }}!"
    success_msg: "Expected {{ outer_item.version }}, and found {{ __checkmk_var_version_number }}."

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify Checkmk edition."
  ansible.builtin.assert:
    that: "outer_item.edition == __checkmk_var_version_edition"
    fail_msg: "Expected {{ outer_item.edition }}, but found {{ __checkmk_var_version_edition }}!"
    success_msg: "Expected {{ outer_item.edition }}, and found {{ __checkmk_var_version_edition }}."

## We need this hack to overwrite the colliding global variable
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Use variables from inventory."
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  when: outer_item.site == "stable_cme"
  block:
    - name: "Set checkmk_var_server_url for isolated testing."
      ansible.builtin.set_fact:
        checkmk_var_server_url: "http://127.0.0.1:5324/"

    - name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get Checkmk version information."
      ansible.builtin.set_fact:
        __checkmk_var_version: "{{ lookup('checkmk.general.version') }}"

    - name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Extract Checkmk version information."
      ansible.builtin.set_fact:
        __checkmk_var_version_number: "{{ (__checkmk_var_version.split('.')[:-1]) | join('.') }}"
        __checkmk_var_version_edition: "{{ __checkmk_var_version.split('.')[-1] }}"

    - name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify Checkmk version."
      ansible.builtin.assert:
        that: "outer_item.version == __checkmk_var_version_number"
        fail_msg: "Expected {{ outer_item.version }} , but found {{ __checkmk_var_version_number }}!"
        success_msg: "Expected {{ outer_item.version }} , and found {{ __checkmk_var_version_number }}."

    - name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify Checkmk edition."
      ansible.builtin.assert:
        that: "outer_item.edition == __checkmk_var_version_edition"
        fail_msg: "Expected {{ outer_item.edition }} , but found {{ __checkmk_var_version_edition }}!"
        success_msg: "Expected {{ outer_item.edition }} , and found {{ __checkmk_var_version_edition }}."
