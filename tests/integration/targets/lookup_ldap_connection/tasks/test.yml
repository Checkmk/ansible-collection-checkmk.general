---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer attribute."
  ansible.builtin.set_fact:
    checkmk_var_customer: "{{ 'provider' if outer_item.edition == 'cme' else None }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create LDAP connection."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    ldap_config: "{{ checkmk_var_ldap_connection.ldap_config }}"
    state: "present"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} Get attributes of LDAP connection."
  ansible.builtin.debug:
    msg: "Description of {{ checkmk_var_ldap_connection.ldap_config.general_properties.id }} is {{ __checkmk_var_ldap_connection.general_properties.description }}"
  vars:
    __checkmk_var_ldap_connection: "{{ lookup('checkmk.general.ldap_connection',
                    checkmk_var_ldap_connection.ldap_config.general_properties.id,
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    automation_user=checkmk_var_automation_user,
                    automation_secret=checkmk_var_automation_secret)
              }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify LDAP connection description."
  ansible.builtin.assert:
    that: "checkmk_var_ldap_connection.ldap_config.general_properties.description == __checkmk_var_ldap_connection.general_properties.description"
  vars:
    __checkmk_var_ldap_connection: "{{ lookup('checkmk.general.ldap_connection',
                    checkmk_var_ldap_connection.ldap_config.general_properties.id,
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    automation_user=checkmk_var_automation_user,
                    automation_secret=checkmk_var_automation_secret)
              }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
