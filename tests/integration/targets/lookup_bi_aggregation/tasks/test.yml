---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: "provider"
  when: outer_item.edition == "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: null
  when: outer_item.edition != "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get BI aggregation 'default_aggregation'."
  ansible.builtin.debug:
    var: __checkmk_var_bi_aggregation
  vars:
    __checkmk_var_bi_aggregation: "{{ lookup('checkmk.general.bi_aggregation',
                    'default_aggregation',
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    automation_user=checkmk_var_automation_user,
                    automation_secret=checkmk_var_automation_secret)
              }}"
  delegate_to: localhost

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify BI aggregation pack ID."
  ansible.builtin.assert:
    that: "__checkmk_var_bi_aggregation.pack_id == 'default'"
  vars:
    __checkmk_var_bi_aggregation: "{{ lookup('checkmk.general.bi_aggregation',
                    'default_aggregation',
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    automation_user=checkmk_var_automation_user,
                    automation_secret=checkmk_var_automation_secret)
              }}"
  delegate_to: localhost

# These do not work currently, but the issue is independent and affects other modules as well. So we disable them only for now.
# - name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Use variables outside the module call."
#   ansible.builtin.assert:
#     that: "__checkmk_var_bi_aggregation.pack_id == 'default'"
#   vars:  # Variables are taken from `tests/integration/files/includes/vars/global.yml`
#     __checkmk_var_bi_aggregation: "{{ lookup('checkmk.general.bi_aggregation', 'default_aggregation')"
#   delegate_to: localhost
