---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer attribute."
  ansible.builtin.set_fact:
    checkmk_var_customer: "{{ 'provider' if outer_item.edition == 'cme' else None }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get Checkmk bakery status."
  ansible.builtin.debug:
    msg: "Bakery status is {{ __checkmk_var_result_bakery }}"
  vars:
    __checkmk_var_result_bakery: "{{ lookup('checkmk.general.bakery',
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    api_user=checkmk_var_api_user,
                    api_secret=checkmk_var_api_secret)
              }}"
  register: __checkmk_var_result_bakery

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify bakery status."
  ansible.builtin.assert:
    that: ('finished' in __checkmk_var_result_bakery.msg) | bool or
          ('running' in __checkmk_var_result_bakery.msg) | bool or
          ('initialized' in __checkmk_var_result_bakery.msg) | bool or
          ('stopped' in __checkmk_var_result_bakery.msg) | bool or
          ('exception' in __checkmk_var_result_bakery.msg) | bool

# We need this hack to overwrite the colliding global variable
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Use variables from inventory."
  when: outer_item.site == "beta_cme"
  block:
    - name: "Set checkmk_var_server_url for isolated testing."
      ansible.builtin.set_fact:
        checkmk_var_server_url: "http://127.0.0.1:5105/"

    - name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Test plugin with variables from inventory."
      ansible.builtin.assert:
        that: ('finished' in __checkmk_var_result_bakery_internal) | bool or
              ('running' in __checkmk_var_result_bakery_internal) | bool or
              ('initialized' in __checkmk_var_result_bakery_internal) | bool or
              ('stopped' in __checkmk_var_result_bakery_internal) | bool or
              ('exception' in __checkmk_var_result_bakery_internal) | bool
      vars:
        __checkmk_var_result_bakery_internal: "{{ lookup('checkmk.general.bakery') }}"
