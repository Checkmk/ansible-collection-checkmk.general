---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer attribute."
  ansible.builtin.set_fact:
    checkmk_var_customer: "{{ 'provider' if outer_item.edition == 'cme' else None }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create host."
  host:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    name: "{{ checkmk_var_host.name }}"
    folder: "{{ checkmk_var_host.folder }}"
    attributes:
      site: "{{ outer_item.site }}"
      ipaddress: 127.0.0.1
      alias: "{{ checkmk_var_host.alias }}"
    state: "present"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.host }} - Get attributes of host."
  ansible.builtin.debug:
    msg: "Alias of {{ checkmk_var_host.name }} is {{ __checkmk_var_host.attributes.alias }}"
  vars:
    __checkmk_var_host: "{{ lookup('checkmk.general.host',
                    checkmk_var_host.name,
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    api_user=checkmk_var_api_user,
                    api_secret=checkmk_var_api_secret)
              }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify host alias."
  ansible.builtin.assert:
    that: "checkmk_var_host.alias == __checkmk_var_host.attributes.alias"
  vars:
    __checkmk_var_host: "{{ lookup('checkmk.general.host',
                    checkmk_var_host.name,
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    api_user=checkmk_var_api_user,
                    api_secret=checkmk_var_api_secret)
              }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

# We need this hack to overwrite the colliding global variable
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Use variables from inventory."
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  when: outer_item.site == "stable_cme"
  block:
    - name: "Set checkmk_var_server_url for isolated testing."
      ansible.builtin.set_fact:
        checkmk_var_server_url: "http://127.0.0.1:5104/"

    - name: "Test plugin with variables from inventory."
      ansible.builtin.assert:
        that: "checkmk_var_host.alias == __checkmk_var_host.attributes.alias"
      vars:
        __checkmk_var_host: "{{ lookup('checkmk.general.host', checkmk_var_host.name) }}"
