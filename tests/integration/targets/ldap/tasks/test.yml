---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: "provider"
  when: (outer_item.edition == "cme") or (outer_item.edition == "cce")

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: null
  when: not ((outer_item.edition == "cme") or (outer_item.edition == "cce"))

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create an LDAP connection."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    ldap_config: "{{ item.ldap_config }}"
    state: "present"
  delegate_to: localhost
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create an LDAP connection. Again."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    ldap_config: "{{ item.ldap_config }}"
    state: "present"
  delegate_to: localhost
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  run_once: true  # noqa run-once[task]
  register: __checkmk_var_result_create
  failed_when: __checkmk_var_result_create.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update an LDAP connection."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id | ternary(item.ldap_config.general_properties.id, omit) }}"
        rule_activation: "{{ item.ldap_config.general_properties.rule_activation | ternary(item.ldap_config.general_properties.rule_activation, omit) }}"
        comment: "New comment."
        description: "{{ item.ldap_config.general_properties.description | ternary(item.ldap_config.general_properties.description, omit) }}"
        documentation_url: "{{ item.ldap_config.general_properties.documentation_url | ternary(item.ldap_config.general_properties.documentation_url, omit) }}"
      ldap_connection: "{{ item.ldap_config.ldap_connection | ternary(item.ldap_config.ldap_connection, omit) }}"
      users: "{{ item.ldap_config.users | ternary(item.ldap_config.users, omit) }}"
      groups: "{{ item.ldap_config.groups | ternary(item.ldap_config.groups, omit) }}"
      sync_plugins: "{{ item.ldap_config.sync_plugins | ternary(item.ldap_config.sync_plugins, omit) }}"
    state: "present"
  delegate_to: localhost
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  run_once: true  # noqa run-once[task]
  register: __checkmk_var_result_create
  failed_when: __checkmk_var_result_create.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update an LDAP connection. Again."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id != None | ternary(item.ldap_config.general_properties.id, omit) }}"
        rule_activation: "{{ item.ldap_config.general_properties.rule_activation != None | ternary(item.ldap_config.general_properties.rule_activation, omit) }}"
        comment: "New comment."
        description: "{{ item.ldap_config.general_properties.description != None | ternary(item.ldap_config.general_properties.description, omit) }}"
        documentation_url: "{{ item.ldap_config.general_properties.documentation_url != None | ternary(item.ldap_config.general_properties.documentation_url, omit) }}"
      ldap_connection: "{{ item.ldap_config.ldap_connection != None | ternary(item.ldap_config.ldap_connection, omit) }}"
      users: "{{ item.ldap_config.users != None | ternary(item.ldap_config.users, omit) }}"
      groups: "{{ item.ldap_config.groups != None | ternary(item.ldap_config.groups, omit) }}"
      sync_plugins: "{{ item.ldap_config.sync_plugins != None | ternary(item.ldap_config.sync_plugins, omit) }}"
    state: "present"
  delegate_to: localhost
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  run_once: true  # noqa run-once[task]
  register: __checkmk_var_result_create
  failed_when: __checkmk_var_result_create.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete LDAP connection."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id }}"
    state: "absent"
  delegate_to: localhost
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete LDAP connection. Again."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id }}"
    state: "absent"
  delegate_to: localhost
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  run_once: true  # noqa run-once[task]
  register: __checkmk_var_result_delete
  failed_when: __checkmk_var_result_delete.changed | bool
