---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer attribute."
  ansible.builtin.set_fact:
    checkmk_var_customer: "{{ 'provider' if outer_item.edition == 'cme' else None }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create an LDAP connection."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    ldap_config: "{{ item.ldap_config }}"
    state: "present"
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create an LDAP connection. Again."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    ldap_config: "{{ item.ldap_config }}"
    state: "present"
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  register: __checkmk_var_result_create
  failed_when: __checkmk_var_result_create.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update an LDAP connection."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id | default(omit) }}"
        rule_activation: "{{ item.ldap_config.general_properties.rule_activation | default(omit) }}"
        comment: "New comment."
        description: "{{ item.ldap_config.general_properties.description | default(omit) }}"
        documentation_url: "{{ item.ldap_config.general_properties.documentation_url | default(omit) }}"
      ldap_connection: "{{ item.ldap_config.ldap_connection | default(omit) }}"
      users: "{{ item.ldap_config.users | default(omit) }}"
      groups: "{{ item.ldap_config.groups | default(omit) }}"
      sync_plugins: "{{ item.ldap_config.sync_plugins | default(omit) }}"
    state: "present"
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update an LDAP connection. Again."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id | default(omit) }}"
        rule_activation: "{{ item.ldap_config.general_properties.rule_activation | default(omit) }}"
        comment: "New comment."
        description: "{{ item.ldap_config.general_properties.description | default(omit) }}"
        documentation_url: "{{ item.ldap_config.general_properties.documentation_url | default(omit) }}"
      ldap_connection: "{{ item.ldap_config.ldap_connection | default(omit) }}"
      users: "{{ item.ldap_config.users | default(omit) }}"
      groups: "{{ item.ldap_config.groups | default(omit) }}"
      sync_plugins: "{{ item.ldap_config.sync_plugins | default(omit) }}"
    state: "present"
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  register: __checkmk_var_result_create
  failed_when: __checkmk_var_result_create.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete LDAP connection."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id }}"
    state: "absent"
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete LDAP connection. Again."
  ldap:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    ldap_config:
      general_properties:
        id: "{{ item.ldap_config.general_properties.id }}"
    state: "absent"
  loop: "{{ checkmk_var_ldap_connections }}"
  loop_control:
    label: "{{ item.ldap_config.general_properties.id }}"
  register: __checkmk_var_result_delete
  failed_when: __checkmk_var_result_delete.changed | bool
