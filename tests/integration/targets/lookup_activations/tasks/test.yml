---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: "provider"
  when: outer_item.edition == "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: null
  when: outer_item.edition != "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create hosts."
  host:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    name: "{{ item.name }}"
    folder: "{{ item.folder }}"
    attributes:
      site: "{{ outer_item.site }}"
      ipaddress: 127.0.0.1
    state: "present"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop: "{{ checkmk_var_hosts }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate changes with redirect."
  activation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    redirect: true
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Get all activations."
  ansible.builtin.assert:
    that: __checkmk_var_activations | length > 0
  vars:
    __checkmk_var_activations: "{{ lookup('checkmk.general.activations',
                    server_url=checkmk_var_server_url,
                    site=outer_item.site,
                    validate_certs=False,
                    automation_user=checkmk_var_automation_user,
                    automation_secret=checkmk_var_automation_secret)
              }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - List activations after one activation."
  ansible.builtin.debug:
    msg: "{{ item.title }} for {{ item.id }}"
  loop: "{{ lookup('checkmk.general.activations',
             server_url=checkmk_var_server_url,
             site=outer_item.site,
             validate_certs=False,
             automation_user=checkmk_var_automation_user,
             automation_secret=checkmk_var_automation_secret)
         }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop_control:
    label: "{{ item.id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete hosts."
  host:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    name: "{{ item.name }}"
    folder: "{{ item.folder }}"
    attributes:
      site: "{{ outer_item.site }}"
      ipaddress: 127.0.0.1
    state: "absent"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop: "{{ checkmk_var_hosts }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate changes without redirect."
  activation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    redirect: false
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - List activations after two activations."
  ansible.builtin.debug:
    msg: "{{ item.title }} for {{ item.id }}"
  loop: "{{ lookup('checkmk.general.activations',
             server_url=checkmk_var_server_url,
             site=outer_item.site,
             validate_certs=False,
             automation_user=checkmk_var_automation_user,
             automation_secret=checkmk_var_automation_secret)
         }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop_control:
    label: "{{ item.id }}"
