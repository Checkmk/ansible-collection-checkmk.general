---
- name: "Include Global Variables."
  ansible.builtin.include_vars: "{{ lookup('ansible.builtin.first_found', checkmk_var_params) }}"
  vars:
    checkmk_var_params:
      files:
        - global.yml
      paths:
        - /home/runner/work/ansible-collection-checkmk.general/ansible-collection-checkmk.general/ansible_collections/checkmk/general/tests/integration/files/includes/vars/
        - /root/ansible_collections/checkmk/general/tests/integration/files/includes/vars/
        - tests/integration/files/includes/vars/

- name: "Print Identifier."
  ansible.builtin.debug:
    msg: "{{ ansible_facts['system_vendor'] }} {{ ansible_facts['product_name'] }} running {{ ansible_facts['virtualization_type'] }}"

- name: "Run preparations."
  ansible.builtin.include_tasks: "{{ lookup('ansible.builtin.first_found', checkmk_var_params) }}"
  vars:
    checkmk_var_params:
      files:
        - prep.yml
      paths:
        - /home/runner/work/ansible-collection-checkmk.general/ansible-collection-checkmk.general/ansible_collections/checkmk/general/tests/integration/files/includes/tasks/
        - /root/ansible_collections/checkmk/general/tests/integration/files/includes/tasks/
        - tests/integration/files/includes/tasks/
  when:
    - ansible_facts['virtualization_type'] in ['container', 'podman', 'docker']
    - (ansible_facts['system_vendor'] == "Dell Inc." and 'Latitude' in ansible_facts['product_name']) or (ansible_facts['system_vendor'] == "QEMU" and 'Ubuntu' in ansible_facts['product_name'])

- name: "Inject a Key into the Sites when running outside of the Container."  # noqa no-changed-when
  ansible.builtin.shell: |
    if command -v docker &> /dev/null; then
        for container in $(docker ps -q)
        do
          for site in $(docker exec $container ls /omd/sites/ 2>/dev/null)
          do
            docker cp targets/bakery/files/agent_signature_keys.mk $container:/omd/sites/$site/etc/check_mk/multisite.d/wato/agent_signature_keys.mk
          done
        done
    fi

    if command -v podman &> /dev/null; then
        for container in $(podman ps -q)
        do
          for site in $(podman exec $container ls /omd/sites/ 2>/dev/null)
          do
            podman cp targets/bakery/files/agent_signature_keys.mk $container:/omd/sites/$site/etc/check_mk/multisite.d/wato/agent_signature_keys.mk
          done
        done
    fi
  args:
    executable: /bin/bash
  when: ansible_facts['system_vendor'] == "Microsoft Corporation" and ansible_facts['product_name'] == "Virtual Machine" and ansible_facts['virtualization_type'] == "VirtualPC"

- name: "Inject a Key into the Sites when running inside of the Container."
  ansible.builtin.copy:
    src: "{{ lookup('ansible.builtin.first_found', checkmk_var_params) }}"
    dest: /omd/sites/{{ outer_item.site }}/etc/check_mk/multisite.d/wato/agent_signature_keys.mk
    owner: "{{ outer_item.site }}"
    group: "{{ outer_item.site }}"
    mode: "0644"
  vars:
    checkmk_var_params:
      files:
        - agent_signature_keys.mk
      paths:
        - /home/runner/work/ansible-collection-checkmk.general/ansible-collection-checkmk.general/ansible_collections/checkmk/general/tests/integration/targets/bakery/files/
        - /root/ansible_collections/checkmk/general/tests/integration/targets/bakery/files/
        - tests/integration/targets/bakery/files/
  loop: "{{ checkmk_var_test_sites }}"
  loop_control:
    loop_var: outer_item
  when:
    - ansible_facts['virtualization_type'] in ['container', 'podman', 'docker']
    - (ansible_facts['system_vendor'] == "Dell Inc." and 'Latitude' in ansible_facts['product_name']) or (ansible_facts['system_vendor'] == "QEMU" and 'Ubuntu' in ansible_facts['product_name'])

- name: "Testing."
  ansible.builtin.include_tasks: test.yml
  loop: "{{ checkmk_var_test_sites }}"
  loop_control:
    loop_var: outer_item
