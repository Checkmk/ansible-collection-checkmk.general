---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: "provider"
  when: outer_item.edition == "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: null
  when: outer_item.edition != "cme"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create notification rule."
  notification_rule:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_config:
      rule_properties:
        description: "Test notification rule"
        comment: "Created by Ansible integration test"
        documentation_url: ""
        do_not_apply_this_rule:
          state: "disabled"
        allow_users_to_deactivate:
          state: "enabled"
      notification_method:
        notify_plugin:
          option: "create_notification_with_the_following_parameters"
          plugin_params:
            plugin_name: "mail"
            from_details:
              state: "disabled"
            reply_to:
              state: "disabled"
            subject_for_host_notifications:
              state: "disabled"
            subject_for_service_notifications:
              state: "disabled"
            sort_order_for_bulk_notifications:
              state: "disabled"
            send_separate_notification_to_every_recipient:
              state: "disabled"
            info_to_be_displayed_in_the_email_body:
              state: "disabled"
            insert_html_section_between_body_and_table:
              state: "disabled"
            url_prefix_for_links_to_checkmk:
              state: "disabled"
            enable_sync_smtp:
              state: "disabled"
            display_graphs_among_each_other:
              state: "disabled"
            graphs_per_notification:
              state: "disabled"
            bulk_notifications_with_graphs:
              state: "disabled"
        notification_bulking:
          state: "disabled"
      contact_selection:
        all_contacts_of_the_notified_object:
          state: "enabled"
        all_users:
          state: "disabled"
        all_users_with_an_email_address:
          state: "disabled"
        the_following_users:
          state: "disabled"
        members_of_contact_groups:
          state: "disabled"
        explicit_email_addresses:
          state: "disabled"
        restrict_by_custom_macros:
          state: "disabled"
        restrict_by_contact_groups:
          state: "disabled"
      conditions:
        match_sites:
          state: "disabled"
        match_folder:
          state: "disabled"
        match_host_tags:
          state: "disabled"
        match_host_labels:
          state: "disabled"
        match_host_groups:
          state: "disabled"
        match_hosts:
          state: "disabled"
        match_exclude_hosts:
          state: "disabled"
        match_service_labels:
          state: "disabled"
        match_service_groups:
          state: "disabled"
        match_exclude_service_groups:
          state: "disabled"
        match_service_groups_regex:
          state: "disabled"
        match_exclude_service_groups_regex:
          state: "disabled"
        match_services:
          state: "disabled"
        match_exclude_services:
          state: "disabled"
        match_check_types:
          state: "disabled"
        match_plugin_output:
          state: "disabled"
        match_contact_groups:
          state: "disabled"
        match_service_levels:
          state: "disabled"
        match_only_during_time_period:
          state: "disabled"
        match_host_event_type:
          state: "disabled"
        match_service_event_type:
          state: "disabled"
        restrict_to_notification_numbers:
          state: "disabled"
        throttle_periodic_notifications:
          state: "disabled"
        match_notification_comment:
          state: "disabled"
        event_console_alerts:
          state: "disabled"
    state: "present"
  register: __checkmk_var_notification_rule_create
  failed_when: __checkmk_var_notification_rule_create.failed

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify notification rule created."
  ansible.builtin.assert:
    that:
      - __checkmk_var_notification_rule_create.changed is true
      - "'200 - OK: The operation was done successfully' in __checkmk_var_notification_rule_create.msg"
    fail_msg: "Notification rule was not created successfully!"
    success_msg: "Notification rule created successfully."

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update notification rule."
  notification_rule:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_id: "{{ __checkmk_var_notification_rule_create.content.id }}"
    rule_config:
      rule_properties:
        description: "Updated test notification rule"
        comment: "Updated by Ansible integration test"
        documentation_url: ""
        do_not_apply_this_rule:
          state: "disabled"
        allow_users_to_deactivate:
          state: "enabled"
      notification_method:
        notify_plugin:
          option: "create_notification_with_the_following_parameters"
          plugin_params:
            plugin_name: "mail"
            from_details:
              state: "disabled"
            reply_to:
              state: "disabled"
            subject_for_host_notifications:
              state: "disabled"
            subject_for_service_notifications:
              state: "disabled"
            sort_order_for_bulk_notifications:
              state: "disabled"
            send_separate_notification_to_every_recipient:
              state: "disabled"
            info_to_be_displayed_in_the_email_body:
              state: "disabled"
            insert_html_section_between_body_and_table:
              state: "disabled"
            url_prefix_for_links_to_checkmk:
              state: "disabled"
            enable_sync_smtp:
              state: "disabled"
            display_graphs_among_each_other:
              state: "disabled"
            graphs_per_notification:
              state: "disabled"
            bulk_notifications_with_graphs:
              state: "disabled"
        notification_bulking:
          state: "disabled"
      contact_selection:
        all_contacts_of_the_notified_object:
          state: "enabled"
        all_users:
          state: "disabled"
        all_users_with_an_email_address:
          state: "disabled"
        the_following_users:
          state: "disabled"
        members_of_contact_groups:
          state: "disabled"
        explicit_email_addresses:
          state: "disabled"
        restrict_by_custom_macros:
          state: "disabled"
        restrict_by_contact_groups:
          state: "disabled"
      conditions:
        match_sites:
          state: "disabled"
        match_folder:
          state: "disabled"
        match_host_tags:
          state: "disabled"
        match_host_labels:
          state: "disabled"
        match_host_groups:
          state: "disabled"
        match_hosts:
          state: "disabled"
        match_exclude_hosts:
          state: "disabled"
        match_service_labels:
          state: "disabled"
        match_service_groups:
          state: "disabled"
        match_exclude_service_groups:
          state: "disabled"
        match_service_groups_regex:
          state: "disabled"
        match_exclude_service_groups_regex:
          state: "disabled"
        match_services:
          state: "disabled"
        match_exclude_services:
          state: "disabled"
        match_check_types:
          state: "disabled"
        match_plugin_output:
          state: "disabled"
        match_contact_groups:
          state: "disabled"
        match_service_levels:
          state: "disabled"
        match_only_during_time_period:
          state: "disabled"
        match_host_event_type:
          state: "disabled"
        match_service_event_type:
          state: "disabled"
        restrict_to_notification_numbers:
          state: "disabled"
        throttle_periodic_notifications:
          state: "disabled"
        match_notification_comment:
          state: "disabled"
        event_console_alerts:
          state: "disabled"
    state: "present"
  register: __checkmk_var_notification_rule_update
  failed_when: __checkmk_var_notification_rule_update.failed

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify notification rule updated."
  ansible.builtin.assert:
    that:
      - __checkmk_var_notification_rule_update.changed is true
      - "'200 - OK: The operation was done successfully' in __checkmk_var_notification_rule_update.msg"
    fail_msg: "Notification rule was not updated successfully!"
    success_msg: "Notification rule updated successfully."

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete notification rule."
  notification_rule:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_id: "{{ __checkmk_var_notification_rule_create.content.id }}"
    state: "absent"
  register: __checkmk_var_notification_rule_delete
  failed_when: __checkmk_var_notification_rule_delete.failed

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Verify notification rule deleted."
  ansible.builtin.assert:
    that:
      - __checkmk_var_notification_rule_delete.changed is true
      - "'204 - Operation done successfully. No further output.' in __checkmk_var_notification_rule_delete.msg or '200 - OK: The operation was done successfully' in __checkmk_var_notification_rule_delete.msg"
    fail_msg: "Notification rule was not deleted successfully!"
    success_msg: "Notification rule deleted successfully."

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete notification rule again (idempotency)."
  notification_rule:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    rule_id: "{{ __checkmk_var_notification_rule_create.content.id }}"
    state: "absent"
  register: __checkmk_var_notification_rule_delete_again
  failed_when: __checkmk_var_notification_rule_delete_again.changed
