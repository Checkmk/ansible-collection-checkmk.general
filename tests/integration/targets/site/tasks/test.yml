---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer attribute."
  ansible.builtin.set_fact:
    checkmk_var_customer: "{{ 'provider' if outer_item.edition == 'cme' else None }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create site connection."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    site_connection:
      site_config: "{{ item.site_config }}"
    state: "present"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create site connection again."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    site_connection:
      site_config: "{{ item.site_config }}"
    state: "present"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Log in to remote site."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    site_connection:
      authentication: "{{ item.authentication }}"
    state: "login"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Log in to remote site again."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    site_connection:
      authentication: "{{ item.authentication }}"
    state: "login"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"
  register: __checkmk_var_result_login
  failed_when: __checkmk_var_result_login.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update site connection."
  when: "not '2.5.0' in outer_item.version"
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    site_connection:
      site_config:
        basic_settings:
          alias: "{{ item.site_id }} with new alias"
        configuration_connection:
        status_connection:
    state: "present"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"

# ToDo: Just for Debugging!
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update site connection for 2.5."
  when: "'2.5.0' in outer_item.version"
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    site_connection:
      site_config:
        basic_settings:
          alias: "{{ item.site_id }} with new alias"
        configuration_connection:
          enable_replication: false
          disable_remote_configuration: true
          direct_login_to_web_gui_allowed: true
          replicate_event_console: false
          message_broker_port: 6666
        status_connection:
    state: "present"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Update site connection again. "
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    site_connection:
      site_config:
        basic_settings:
          alias: "{{ item.site_id }} with new alias"
    state: "present"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"
  register: __checkmk_var_result_update
  failed_when: __checkmk_var_result_update.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Log out from remote site."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    state: "logout"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Log out from remote site again."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    state: "logout"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"
  register: __checkmk_var_result_logout
  failed_when: __checkmk_var_result_logout.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete remote site."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    state: "absent"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete remote site again."
  site:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    api_user: "{{ checkmk_var_api_user }}"
    api_secret: "{{ checkmk_var_api_secret }}"
    site_id: "{{ item.site_id }}"
    state: "absent"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"
  register: __checkmk_var_result_delete
  failed_when: __checkmk_var_result_delete.changed | bool

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Run Module using Environment Variables."
  site:
    site_id: "{{ item.site_id }}"
    state: "absent"
  loop: "{{ outer_item.remote_sites }}"
  loop_control:
    label: "{{ item.site_id }}"
  environment: "{{ __checkmk_var_testing_environment }}"
  register: __checkmk_var_result_environment
  failed_when: __checkmk_var_result_environment.changed | bool
