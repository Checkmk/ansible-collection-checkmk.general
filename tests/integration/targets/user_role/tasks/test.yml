---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    customer: "provider"
  when: (outer_item.edition == "cme") or (outer_item.edition == "cce")

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    customer: null
  when: not ((outer_item.edition == "cme") or (outer_item.edition == "cce"))

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create user roles."
  user_role:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    customer: "{{ (customer != None) | ternary(customer, omit) }}"  # See PR #427
    role_id: "{{ item.role_id }}"
    new_alias: "{{ item.new_alias | default(omit) }}"
    new_role_id: "{{ item.new_role_id | default(omit) }}"
    new_permissions: "{{ item.new_permissions | default(omit) }}"
    state: "present"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop: "{{ checkmk_user_roles_create }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate."
  activation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    force_foreign_changes: true
    sites:
      - "{{ outer_item.site }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Modify part of user roles (also checks for idempotency!)."
  user_role:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    role_id: "{{ item.role_id }}"
    new_alias: "{{ item.new_alias | default(omit) }}"
    new_basedon: "{{ item.new_basedon | default(omit) }}"
    new_role_id: "{{ item.new_role_id | default(omit) }}"
    new_permissions: "{{ item.new_permissions | default(omit) }}"
    customer: "{{ (customer != None) | ternary(customer, omit) }}"  # See PR #427
    state: "present"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop: "{{ checkmk_user_roles_modify }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate."
  activation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    force_foreign_changes: true
    sites:
      - "{{ outer_item.site }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete user roles."
  user_role:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    customer: "{{ (customer != None) | ternary(customer, omit) }}"  # See PR #427
    role_id: "{{ item.role_id }}"
    state: "absent"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop: "{{ checkmk_user_roles_delete }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate."
  activation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    force_foreign_changes: true
    sites:
      - "{{ outer_item.site }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete user roles that were created at the beginning (also check for idempotency)."
  user_role:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    customer: "{{ (customer != None) | ternary(customer, omit) }}"  # See PR #427
    role_id: "{{ item.role_id }}"
    state: "absent"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
  loop: "{{ checkmk_user_roles_create }}"

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Activate."
  activation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    force_foreign_changes: true
    sites:
      - "{{ outer_item.site }}"
  delegate_to: localhost
  run_once: true  # noqa run-once[task]
