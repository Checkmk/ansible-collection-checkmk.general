---
- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Set customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: "provider"
  when: (outer_item.edition == "cme") or (outer_item.edition == "cce")

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Unset customer when needed."
  ansible.builtin.set_fact:
    checkmk_var_customer: null
  when: not ((outer_item.edition == "cme") or (outer_item.edition == "cce"))

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Create a BI aggregation."
  bi_aggregation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    automation_auth_type: "bearer"
    aggregation:
      id: "aggr1"
      pack_id: "default"
      comment: "Aggregation comment"
      customer: "{{ (checkmk_var_customer != None) | ternary(checkmk_var_customer, omit) }}"  # See PR #427
      groups:
        names: ["groupA", "groupB"]
        paths:
          - ["path", "group", "a"]
          - ["path", "group", "b"]
      node:
        search:
          type: "empty"
        action:
          type: "call_a_rule"
          rule_id: "host"
          params:
            arguments: []
      aggregation_visualization:
        ignore_rule_styles: false
        layout_id: "builtin_default"
        line_style: "round"
      computation_options:
        disabled: false
        use_hard_states: false
        escalate_downtimes_as_warn: false
        freeze_aggregations: false
    state: "present"
  delegate_to: localhost

- name: "{{ outer_item.version }} - {{ outer_item.edition | upper }} - Delete a BI aggregation."
  bi_aggregation:
    server_url: "{{ checkmk_var_server_url }}"
    site: "{{ outer_item.site }}"
    automation_user: "{{ checkmk_var_automation_user }}"
    automation_secret: "{{ checkmk_var_automation_secret }}"
    automation_auth_type: "bearer"
    aggregation:
      id: "aggr1"
      pack_id: "default"
    state: "absent"
  delegate_to: localhost
