---
# Configure location and credentials for the Checkmk REST API
checkmk_var_server_url: "http://127.0.0.1:{{ outer_item.port | default('80') }}/"
checkmk_var_validate_certs: false
checkmk_var_api_user: "cmkadmin"
checkmk_var_api_secret: "Sup3rSec4et!"

# Generate download URL and provide credentials to download Checkmk setups
checkmk_var_download_url: "https://download.checkmk.com/checkmk/{{ item.version }}/check-mk-{{ __checkmk_server_edition_mapping[item.edition] }}-{{ item.version }}_0.{{ ansible_facts['distribution_release'] }}_amd64.deb"  # noqa yaml[line-length]

# Due to inconsistent naming of editions, we normalize them here for convenience.
__checkmk_var_legacy_edition_mapping:
  cre: raw
  cfe: free
  cee: enterprise
  cce: cloud
  cme: managed

# Due to renaming of editions starting with 2.5.0, we normalize them here for convenience. Again.
__checkmk_var_modern_edition_mapping:
  cre: community
  cee: pro
  cce: ultimate
  cme: ultimatemt
  cse: cloud

# Bringing the above two mappings back together.
__checkmk_server_edition_mapping: >-
  {{
    ( (item.version | regex_replace('p.*', '')) is version('2.5.0', '<') )
    | ternary(__checkmk_var_legacy_edition_mapping, __checkmk_var_modern_edition_mapping)
  }}

# This is a very hacky workaround, as it is not possible to assign variables
# to other variables when using them in lookup modules.
# checkmk_var_server_url: "http://127.0.0.1:5104/"  # see above
# The variable below is especially hacky.
# All integration tests were adapted to run the specific task only on this site.
checkmk_var_site: "stable_cme"

__checkmk_var_testing_environment:
  CHECKMK_VAR_SERVER_URL: "{{ checkmk_var_server_url }}"
  CHECKMK_VAR_SITE: "{{ outer_item.site }}"
  CHECKMK_VAR_VALIDATE_CERTS: "false"
  CHECKMK_VAR_API_AUTH_TYPE: "bearer"
  CHECKMK_VAR_API_USER: "{{ checkmk_var_api_user }}"
  CHECKMK_VAR_API_SECRET: "{{ checkmk_var_api_secret }}"

# Use this to override the test-specific sites for local testing:
# checkmk_var_test_sites:
#   - version: "2.4.0p21"
#     edition: "cme"
#     site: "stable_cme"
#     port: "5104"
#     # Keep aligned with tests/integratin/targets/site/vars/main.yml
#     remote_sites:
#       - site_id: "stable_cme_r1"
#         site_config:
#           status_connection:
#             connection:
#               socket_type: "tcp"
#               port: 6115
#               encrypted: true
#               host: "localhost"
#               verify: false
#             proxy:
#               use_livestatus_daemon: "with_proxy"
#               global_settings: false
#               tcp:
#                 port: 4115
#                 only_from: []
#                 tls: true
#               params:
#                 channels: 6
#                 heartbeat:
#                   interval: 10
#                   timeout: 4
#                 channel_timeout: 6
#                 query_timeout: 240
#                 connect_retry: 5
#                 cache: true
#             connect_timeout: 2
#             status_host:
#               status_host_set: "disabled"
#             url_prefix: "/stable_cme_r1/"
#           configuration_connection:
#             enable_replication: true
#             url_of_remote_site: "http://127.0.0.1:7777/stable_cme_r1/check_mk/"  # Hardcoded ip:port for local testing
#             disable_remote_configuration: true
#             ignore_tls_errors: false
#             direct_login_to_web_gui_allowed: false
#             replicate_event_console: true
#             replicate_extensions: false
#             message_broker_port: 3115
#           basic_settings:
#             site_id: "stable_cme_r1"
#             alias: "stable_cme remote site 1"
#             customer: "provider"
#         authentication:
#           username: "{{ checkmk_var_api_user }}"
#           password: "{{ checkmk_var_api_secret }}"
