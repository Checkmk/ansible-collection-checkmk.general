---
# This is a little hack to take some load off the main Ubuntu servers
# (also their archive.ubuntu.com was not accessible at some point)
# The URL can of course easily be changed to something else, if it makes sense.
# - name: "Change default repositories in Test Container."
#   ansible.builtin.lineinfile:
#     path: /etc/apt/sources.list.d/ubuntu.sources
#     regex: 'URIs: http://archive.ubuntu.com/ubuntu/'
#     line: 'URIs: http://mirror.netcologne.de/ubuntu/'

- name: "Install dependencies."
  ansible.builtin.package:
    name: python3-apt
    state: present

- name: "Get installed Packages."
  ansible.builtin.package_facts:

- name: "Download Checkmk Versions."
  ansible.builtin.get_url:
    url: "{{ checkmk_var_download_url }}"
    dest: /tmp/checkmk-server-{{ item.site }}.deb
    mode: "0640"
    url_username: "{{ checkmk_var_download_user | default(omit) }}"
    url_password: "{{ checkmk_var_download_pass | default(omit) }}"
  loop: "{{ checkmk_var_test_sites }}"
  when: |
    not 'check-mk-' + __checkmk_server_edition_mapping[item.edition] + '-' +item.version in ansible_facts['packages']

- name: "Install Checkmk Versions."
  ansible.builtin.package:
    deb: /tmp/checkmk-server-{{ item.site }}.deb
    state: present
  loop: "{{ checkmk_var_test_sites }}"
  when: |
    not 'check-mk-' + __checkmk_server_edition_mapping[item.edition] + '-' +item.version in ansible_facts['packages']

- name: "Create Central Site."
  vars:
    __checkmk_var_edition_id: >-  # This can be reverted, once 2.5.0 is the oldest supported version
      {{
        ( (item.version | regex_replace('p.*', '')) is version('2.5', '<') )
        | ternary(item.edition, __checkmk_server_edition_mapping[item.edition])
      }}
  ansible.builtin.command: "omd -V {{ item.version }}.{{ __checkmk_var_edition_id }} create --no-tmpfs --admin-password {{ checkmk_var_api_secret }} {{ item.site }}"
  args:
    creates: "/omd/sites/{{ item.site }}"
  loop: "{{ checkmk_var_test_sites }}"

- name: "Create Remote Sites."
  vars:
    __checkmk_var_edition_id: >-  # This can be reverted, once 2.5.0 is the oldest supported version
      {{
        ( (item.0.version | regex_replace('p.*', '')) is version('2.5', '<') )
        | ternary(
            item.0.edition,
            __checkmk_var_modern_edition_mapping[item.0.edition]
          )
      }}
  ansible.builtin.command: "omd -V {{ item.0.version }}.{{ __checkmk_var_edition_id }} create --no-tmpfs --admin-password {{ checkmk_var_api_secret }} {{ item.1.site_config.basic_settings.site_id }}"
  args:
    creates: "/omd/sites/{{ item.1.site_config.basic_settings.site_id }}"
  loop: "{{ checkmk_var_test_sites | subelements('remote_sites', skip_missing=True) }}"

- name: "Configure Checkmk Site Ports (Apache, Livestatus, Broker) - Central Site."
  ansible.builtin.shell:
    cmd: |
      # 1. Configure Apache Port
      omd config {{ item.site }} set APACHE_TCP_PORT {{ item.port | default('5000') }}

      # 2. Configure Livestatus
      omd config {{ item.site }} set LIVESTATUS_TCP on
      omd config {{ item.site }} set LIVESTATUS_TCP_PORT {{ item.remote_sites[0].site_config.status_connection.connection.port | default('6557') }}

      # 3. Configure Message Broker
      {% if item.remote_sites[0].site_config.configuration_connection.message_broker_port is defined %}
      omd config {{ item.site }} set RABBITMQ_TCP_PORT {{ item.remote_sites[0].site_config.configuration_connection.message_broker_port | default('5671') }}
      {% endif %}
  loop: "{{ checkmk_var_test_sites }}"
  loop_control:
    label: "{{ item.site }}"
  changed_when: false

- name: "Configure Checkmk Site Ports (Apache, Livestatus, Broker) - Remote Sites."
  ansible.builtin.shell:
    cmd: |
      # 1. Configure Apache Port
      omd config {{ item.1.site_config.basic_settings.site_id }} set APACHE_TCP_PORT 7777  # Hardcoded port for local testing

      # 2. Configure Livestatus
      omd config {{ item.1.site_config.basic_settings.site_id }} set LIVESTATUS_TCP on
      omd config {{ item.1.site_config.basic_settings.site_id }} set LIVESTATUS_TCP_PORT {{ item.1.site_config.status_connection.proxy.tcp.port | default('6557') }}

      # 3. Configure Message Broker
      {% if item.1.site_config.configuration_connection.message_broker_port is defined %}
      omd config {{ item.1.site_config.basic_settings.site_id }} set RABBITMQ_TCP_PORT {{ item.1.site_config.configuration_connection.message_broker_port | default('5671') }}
      {% endif %}
  loop: "{{ checkmk_var_test_sites | subelements('remote_sites', skip_missing=True) }}"
  loop_control:
    label: "{{ item.1.site_config.basic_settings.site_id }}"
  changed_when: false

- name: "Start Apache2."
  ansible.builtin.service:
    name: apache2
    state: started

- name: "Start Central Site."
  ansible.builtin.shell: "omd status -b {{ item.site }} || omd start {{ item.site }}"
  register: __checkmk_var_site_central_status
  changed_when: __checkmk_var_site_central_status.rc == "0"
  loop: "{{ checkmk_var_test_sites }}"

- name: "Start Remote Sites."
  ansible.builtin.shell: "omd status -b {{ item.1.site_config.basic_settings.site_id }} || omd start {{ item.1.site_config.basic_settings.site_id }}"
  register: __checkmk_var_site_remote_status
  changed_when: __checkmk_var_site_remote_status.rc == "0"
  loop: "{{ checkmk_var_test_sites | subelements('remote_sites', skip_missing=True) }}"

- name: "Wait for Central Site to be ready."
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ item.port }}/{{ item.site }}"
    return_content: true
    validate_certs: false
    status_code:
      - 200
  until: __checkmk_var_site_central_status_online.status == 200
  retries: 30
  delay: 5
  register: __checkmk_var_site_central_status_online
  loop: "{{ checkmk_var_test_sites }}"

- name: "Wait for Remote Sites to be ready."
  ansible.builtin.uri:
    url: "http://127.0.0.1:7777/{{ item.1.site_config.basic_settings.site_id }}"  # Hardcoded ip:port for local testing
    return_content: true
    validate_certs: false
    status_code:
      - 200
  until: __checkmk_var_site_remote_status_online.status == 200
  retries: 30
  delay: 5
  register: __checkmk_var_site_remote_status_online
  loop: "{{ checkmk_var_test_sites | subelements('remote_sites', skip_missing=True) }}"
