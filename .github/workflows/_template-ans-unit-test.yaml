# Resources:
# - About reusable workflows: https://docs.github.com/en/actions/how-tos/reuse-automations/reuse-workflows
# - Template for this file: https://github.com/ansible-collections/collection_template/blob/main/.github/workflows/ansible-test.yml
# - About Ansible integration tests: https://docs.ansible.com/ansible/latest/dev_guide/testing_integration.html

name: Template for Ansible Unit Tests

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      testpath:
        required: true
        type: string

jobs:

  units:
    runs-on: ubuntu-24.04
    name: Units (â’¶${{ matrix.ansible }}+${{ matrix.python }})
    strategy:
      fail-fast: false
      matrix:
        ansible:
          - stable-2.18
          - stable-2.19
          - stable-2.20
          - devel
        python:
          - '3.11'
          - '3.12'
          - '3.13'
        exclude:
          # Exclude unsupported sets.
          - ansible: devel
            python: '3.11'
          - ansible: stable-2.20
            python: '3.11'

    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          path: ansible_collections/checkmk/general

      - name: "Install uv and set the python version."
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python }}
          enable-cache: true

      - name: "Create uv venv."
        run: uv venv
        working-directory: ./ansible_collections/checkmk/general

      - name: Install ansible-base (${{ matrix.ansible }})
        run: uv pip install https://github.com/ansible/ansible/archive/${{ matrix.ansible }}.tar.gz
        working-directory: ./ansible_collections/checkmk/general

      - name: Run unit test
        run: uv run ansible-test units ${{ inputs.testpath}} -v --color --python ${{ matrix.python }} --docker default
        working-directory: ./ansible_collections/checkmk/general
