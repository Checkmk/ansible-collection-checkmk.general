# README:
# Resources:
# - Template for this file: https://github.com/ansible-collections/collection_template/blob/main/.github/workflows/ansible-test.yml

name: Linting

permissions:
  contents: read

on:
  workflow_dispatch:
  workflow_call:
  schedule:
    - cron: '0 0 * * 0'

  push:
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - 'tests/**'
      - '.github/workflows/ansible-lint.yaml'
  pull_request:
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - 'tests/**'

jobs:

  yaml:
    runs-on: ubuntu-24.04
    name: YAML

    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          path: ansible_collections/checkmk/general

      - name: "Install uv."
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          working-directory: ./ansible_collections/checkmk/general/

      - name: "Create uv venv."
        run: uv venv
        working-directory: ./ansible_collections/checkmk/general

      # Run the linting
      - name: "Run yamllint on roles."
        run:  uv run yamllint -c .yamllint ./roles/
        working-directory: ./ansible_collections/checkmk/general/

      - name: "Run yamllint on playbooks."
        run:  uv run yamllint -c .yamllint ./playbooks/
        working-directory: ./ansible_collections/checkmk/general/

      - name: "Run yamllint on tests."
        run:  uv run yamllint -c .yamllint ./tests/
        working-directory: ./ansible_collections/checkmk/general/

  ansible:
    runs-on: ubuntu-24.04
    name: Ansible (â’¶${{ matrix.ansible }})
    strategy:
      fail-fast: false
      matrix:
        ansible:
          - stable-2.18
          - stable-2.19
          - stable-2.20
          - devel

    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          path: ansible_collections/checkmk/general

      - name: "Install uv."
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          working-directory: ./ansible_collections/checkmk/general/

      - name: "Create uv venv."
        run: uv venv
        working-directory: ./ansible_collections/checkmk/general

      - name: Install ansible-base (${{ matrix.ansible }})
        run: uv pip install https://github.com/ansible/ansible/archive/${{ matrix.ansible }}.tar.gz
        working-directory: ./ansible_collections/checkmk/general

      - name: "Install Checkmk Collection."
        run: uv run ansible-galaxy collection install ./
        working-directory: ./ansible_collections/checkmk/general/

      # Run the linting
      - name: "Run ansible-lint on roles."
        run:  uv run ansible-lint -c .ansible-lint ./roles/
        working-directory: ./ansible_collections/checkmk/general/
        env:
          ANSIBLE_LIBRARY: "./plugins/modules"
          ANSIBLE_ROLES_PATH: "./roles"

      - name: "Run ansible-lint on tests."
        run:  uv run ansible-lint -c .ansible-lint ./tests/
        working-directory: ./ansible_collections/checkmk/general/
        env:
          ANSIBLE_LIBRARY: "./plugins/modules"
          ANSIBLE_ROLES_PATH: "./roles"

      - name: "Run ansible-lint on playbooks."
        run:  uv run ansible-lint -c .ansible-lint ./playbooks/
        working-directory: ./ansible_collections/checkmk/general/
        env:
          ANSIBLE_LIBRARY: "./plugins/modules"
          ANSIBLE_ROLES_PATH: "./roles"
